<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <title>Control de Acceso QR</title>
    
    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbzB7Q2LV8hvIQVZledP5MwFJSKIDFHq6WGuiQUxFYGaj0xFIii-9I1OmrVBjWf3llGkFw/exec'; // tu Apps Script Web App URL

        document.addEventListener('DOMContentLoaded', async () => {
            const params = new URLSearchParams(window.location.search);
            const action = params.get('action');
            const id = params.get('userid');
            const punto = params.get('control');

            if (action === 'register' ) {
                await saveToIndexedDB(id);
                showMessage(`✅ ID <strong>${id}</strong> registrado exitosamente en este dispositivo.`);
            }

            if (action === 'checkin' ) {
                const storedId = await getFromIndexedDB();
                if (!storedId) {
                    $('#error').html(`<i class="bi bi-exclamation-circle-fill"></i> Debes registrarte para fichar.`);
                    $('#error').show();
                    //showMessage('⚠️ No hay ID registrado en este dispositivo.');
                    return;
                }
                     
                 if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(async (position) => {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude; 
                        const fechaObj = new Date();
                        const fecha = fechaObj.toLocaleDateString();
                        const hora = fechaObj.toLocaleTimeString();
                        
                        const payload = {
                            id: storedId,
                            punto: punto,
                            action: 'checkin', // Agregar acción
                            lat: lat,
                            lng: lng,
                        };
                        await sendToBackend(payload);
                        //showMessage(`✅ Check-in realizado para <strong>${storedId}</strong> en <strong>${punto}</strong> a las <strong>${fecha}</strong> - <strong>${hora}</strong>.`);
                        $('#success').html(`<i class="bi bi-alarm"></i> ${fecha} ${hora}<br/><b>${punto}</b>: ${storedId}`);
                        $('#loader').hide();
                        $('#success').show();
                    }, (err) => {
                        showMessage('⚠️ Error al obtener la ubicación: ' + err.message);
                    });
                } else {
                    showMessage('⚠️ Geolocalización no soportada en este navegador.');
                }
            }
        });

        // Mostrar mensajes en la página
        function showMessage(msg) {
            document.getElementById('message').innerHTML = msg;
        }

        // IndexedDB
        function openDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('empleadosDB', 1);
                request.onupgradeneeded = (e) => {
                    const db = e.target.result;
                    db.createObjectStore('empleados', { keyPath: 'key' });
                };
                request.onsuccess = (e) => resolve(e.target.result);
                request.onerror = (e) => reject(e);
            });
        }

        async function saveToIndexedDB(id) {
            const db = await openDB();
            const tx = db.transaction('empleados', 'readwrite');
            tx.objectStore('empleados').put({ key: 'empleadoID', value: id });
            await tx.complete;
        }

        async function getFromIndexedDB() {
            const db = await openDB();
            return new Promise((resolve) => {
                const tx = db.transaction('empleados', 'readonly');
                const store = tx.objectStore('empleados');
                const req = store.get('empleadoID');
                req.onsuccess = () => resolve(req.result ? req.result.value : null);
                req.onerror = () => resolve(null);
            });
        }

        async function sendToBackend(data) {
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    mode: 'no-cors',
                    body: JSON.stringify(data)
                });
        
                // Con no-cors, generalmente solo puedes verificar si la petición fue aceptada
                if (response.ok) {
                    console.log('Petición enviada exitosamente al servidor (modo no-cors).');
                    // No intentes acceder al cuerpo de la respuesta aquí, ya que no estará disponible
                } else {
                    console.error('Error al enviar la petición al servidor (modo no-cors):', response.status, response.statusText);
                }
            } catch (error) {
                console.error('Error al enviar la petición:', error);
            }
        }
    </script>
</head>

<body class="bg-light">
    <div class="container">
        <div id="loader" class="spinner-grow" role="status" style="display: none">
        </div>
        <div id="success" class="alert alert-success" role="alert" style="display: none; font-size: 3em;">
        </div>
        <div id="error" class="alert alert-danger" role="alert" style="display: none; font-size: 3em;">
        </div>

    </div>

   
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>

</body>

</html>






