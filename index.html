<!DOCTYPE html>
<html lang="en">

    <head>
    <meta charset="UTF-8">
    <title>Registro de Empleados + Geolocalización</title>
    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbw1T6VQ8jzpIkD-sv5xE4Ds-SvxR9zHWE6yP3Z5DhabBuxRF6eS2D23GEH64qtfPIqSnQ/exec'; // tu Apps Script Web App URL

        document.addEventListener('DOMContentLoaded', async () => {
            const params = new URLSearchParams(window.location.search);
            const action = params.get('action');
            const id = params.get('userid');
            const punto = params.get('control');

            if (action === 'register' ) {
                await saveToIndexedDB(id);
                showMessage(`✅ ID <strong>${id}</strong> registrado exitosamente en este dispositivo.`);
            }

            if (action === 'checkin' ) {
                const storedId = await getFromIndexedDB();
                if (!storedId) {
                    showMessage('⚠️ No hay ID registrado en este dispositivo.');
                    return;
                }
                     
                 if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(async (position) => {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude; 
                        const fechaObj = new Date();
                        const fecha = fechaObj.toLocaleDateString();
                        const hora = fechaObj.toLocaleTimeString();
                        
                        const payload = {
                            id: storedId,
                            punto: punto,
                            timestamp: fechaObj.toISOString(),
                            lat: lat,
                            lng: lng
                        };
                        //await sendToBackend(payload);
                        showMessage(`✅ Check-in realizado para <strong>${storedId}</strong> en <strong>${punto}</strong> a las <strong>${fecha}</strong> - <strong>${hora}</strong>.`);
                    }, (err) => {
                        showMessage('⚠️ Error al obtener la ubicación: ' + err.message);
                    });
                } else {
                    showMessage('⚠️ Geolocalización no soportada en este navegador.');
                }
            }
        });

        // Mostrar mensajes en la página
        function showMessage(msg) {
            document.getElementById('message').innerHTML = msg;
        }

        // IndexedDB
        function openDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('empleadosDB', 1);
                request.onupgradeneeded = (e) => {
                    const db = e.target.result;
                    db.createObjectStore('empleados', { keyPath: 'key' });
                };
                request.onsuccess = (e) => resolve(e.target.result);
                request.onerror = (e) => reject(e);
            });
        }

        async function saveToIndexedDB(id) {
            const db = await openDB();
            const tx = db.transaction('empleados', 'readwrite');
            tx.objectStore('empleados').put({ key: 'empleadoID', value: id });
            await tx.complete;
        }

        async function getFromIndexedDB() {
            const db = await openDB();
            return new Promise((resolve) => {
                const tx = db.transaction('empleados', 'readonly');
                const store = tx.objectStore('empleados');
                const req = store.get('empleadoID');
                req.onsuccess = () => resolve(req.result ? req.result.value : null);
                req.onerror = () => resolve(null);
            });
        }

        async function sendToBackend(data) {
            const response = await fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify(data),
                headers: { 'Content-Type': 'application/json' }
            });
            const result = await response.json();
            console.log(result);
        }
    </script>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            text-align: center;
        }
        #message {
            margin-top: 30px;
            font-size: 18px;
        }
    </style>
</head>

<body>
    <h1>Registro de empleados con geolocalización</h1>
    <p>Escanea el QR para registrar o hacer check-in.</p>
    <div id="message"></div>
</body>

</html>

