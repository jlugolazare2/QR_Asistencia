<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Empleados + Geolocalización</title>
    <!-- Bootstrap CDN -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-pzjw8f+ua7Kw1TIq0pXzA0W1Q0NzKdyXkD30l0FbZ+hsBX1rdX0buFf0JX0zMG3d" crossorigin="anonymous">
    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbzB7Q2LV8hvIQVZledP5MwFJSKIDFHq6WGuiQUxFYGaj0xFIii-9I1OmrVBjWf3llGkFw/exec'; // tu Apps Script Web App URL

        document.addEventListener('DOMContentLoaded', async () => {
            const params = new URLSearchParams(window.location.search);
            const action = params.get('action');
            const id = params.get('userid');
            const punto = params.get('control');

            if (action === 'register' ) {
                await saveToIndexedDB(id);
                showMessage(`✅ ID <strong>${id}</strong> registrado exitosamente en este dispositivo.`);
            }

            if (action === 'checkin' ) {
                const storedId = await getFromIndexedDB();
                if (!storedId) {
                    showMessage('⚠️ No hay ID registrado en este dispositivo.');
                    return;
                }
                     
                 if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(async (position) => {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude; 
                        const fechaObj = new Date();
                        const fecha = fechaObj.toLocaleDateString();
                        const hora = fechaObj.toLocaleTimeString();
                        
                        const payload = {
                            id: storedId,
                            punto: punto,
                            action: 'checkin', // Agregar acción
                            lat: lat,
                            lng: lng,
                        };
                        await sendToBackend(payload);
                        showMessage(`✅ Check-in realizado para <strong>${storedId}</strong> en <strong>${punto}</strong> a las <strong>${fecha}</strong> - <strong>${hora}</strong>.`);
                    }, (err) => {
                        showMessage('⚠️ Error al obtener la ubicación: ' + err.message);
                    });
                } else {
                    showMessage('⚠️ Geolocalización no soportada en este navegador.');
                }
            }
        });

        // Mostrar mensajes en la página
        function showMessage(msg) {
            document.getElementById('message').innerHTML = msg;
        }

        // IndexedDB
        function openDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('empleadosDB', 1);
                request.onupgradeneeded = (e) => {
                    const db = e.target.result;
                    db.createObjectStore('empleados', { keyPath: 'key' });
                };
                request.onsuccess = (e) => resolve(e.target.result);
                request.onerror = (e) => reject(e);
            });
        }

        async function saveToIndexedDB(id) {
            const db = await openDB();
            const tx = db.transaction('empleados', 'readwrite');
            tx.objectStore('empleados').put({ key: 'empleadoID', value: id });
            await tx.complete;
        }

        async function getFromIndexedDB() {
            const db = await openDB();
            return new Promise((resolve) => {
                const tx = db.transaction('empleados', 'readonly');
                const store = tx.objectStore('empleados');
                const req = store.get('empleadoID');
                req.onsuccess = () => resolve(req.result ? req.result.value : null);
                req.onerror = () => resolve(null);
            });
        }

        async function sendToBackend(data) {
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    mode: 'no-cors',
                    body: JSON.stringify(data)
                });
        
                // Con no-cors, generalmente solo puedes verificar si la petición fue aceptada
                if (response.ok) {
                    console.log('Petición enviada exitosamente al servidor (modo no-cors).');
                    // No intentes acceder al cuerpo de la respuesta aquí, ya que no estará disponible
                } else {
                    console.error('Error al enviar la petición al servidor (modo no-cors):', response.status, response.statusText);
                }
            } catch (error) {
                console.error('Error al enviar la petición:', error);
            }
        }
    </script>
</head>

<body class="bg-light">
    <div class="container">
        <h1 class="text-center mt-5 mb-4">Registro de empleados con geolocalización</h1>
        <p class="text-center mb-4">Escanea el QR para registrar o hacer check-in.</p>

        <div id="message" class="alert alert-info" role="alert"></div>

        <!-- Agregar un botón para interactuar o instrucciones -->
        <div class="text-center mt-4">
            <a href="#" class="btn btn-primary btn-lg">Escanear QR</a>
        </div>
    </div>

    <!-- Bootstrap JS y dependencias -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zyQ2z9PE7gmhFf5OHVs9r+Xoh5f5YdlwZf+Ug0k2" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.0.5/dist/umd/popper.min.js" integrity="sha384-pzjw8f+ua7Kw1TIq0pXzA0W1Q0NzKdyXkD30l0FbZ+hsBX1rdX0buFf0JX0zMG3d" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js" integrity="sha384-pzjw8f+ua7Kw1TIq0pXzA0W1Q0NzKdyXkD30l0FbZ+hsBX1rdX0buFf0JX0zMG3d" crossorigin="anonymous"></script>
</body>

</html>






